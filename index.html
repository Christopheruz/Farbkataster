<!DOCTYPE html>
<html lang="de">   
<head>
  <meta charset="UTF-8" />
  <title>Excel lokal laden per Dateiauswahl</title>
  <link rel="stylesheet" href="style.css">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
</head>
<body>
<div class="header-zone">
 <header class="site-header">
  <nav class="navbar">
    <!-- Upload zuerst (links) -->
    <div class="header-actions">
      <input type="file" id="fileInput" accept=".xlsx,.xls" class="visually-hidden" />
      <label for="fileInput" class="btn">Excel-Datei auswählen</label>
      <span id="fileName" class="file-name" aria-live="polite"></span>
    </div>

    <!-- Links danach (rückt nach rechts) -->
    <div class="links">
      <a href="#">Start</a>
      <a href="#" aria-current="page">Excel laden</a>
      <a href="#">Kontakt</a>
    </div>
  </nav>
</header>
</div> 


  <div class="page-background">
    <main class="container">
  <h1>Excel-Datei per Auswahl laden</h1>
  <p>Wähle oben im Header eine Excel-Datei aus.</p>
  <p>Alle Angaben sind ohne Gewähr und vor Ort zu prüfen.</p>   

  <div class="layout">
    <!-- Sidebar (links) -->
    <aside class="sidebar">

      <div class="sidebar-logo">
    <img src="colibrilogo.png" alt="Farbarchiv Logo">
  </div>
      <h2 class="sidebar-title">Filter</h2>

      <div class="filter-group">
        <label for="filterGebaeude">Gebäude</label>
        <input type="text" id="filterGebaeude" placeholder="z. B. 3800, Parkhaus …">
      </div>

      <div class="filter-group">
        <label for="filterRaum">Raumnr.</label>
        <input type="text" id="filterRaum" placeholder="z. B. E 05, 090.110, Flur …">
      </div>

      <button type="button" id="clearFilters" class="btn btn-clear">Filter zurücksetzen</button>
      <p class="hint">Die Filter wirken auf die geladene Tabelle.</p>
    </aside>

    <!-- Tabelle (rechts) -->
    <section class="main">
  <!-- Eingabezeile oberhalb der Tabelle -->
  <div class="entry-sticky">    
  <div class="entry-bar">
    
    <div class="entry-fields">
      <div class="field">
       <label for="addGebSel">Gebäude</label>
        <select id="addGebSel">
         <option value="">– bitte wählen –</option>
        </select>
       </div>
     <div class="field">
        <label for="addRaum">Raumnr.</label>
        <input type="text" id="addRaum" placeholder="z. B. E 05, 090.110, Flur …">
      </div>
      <div class="field">
        <label for="addFarb">Farbton</label>
        <input type="text" id="addFarb" placeholder="z. B. RAL 9010 …">
      </div>
      <div class="field">
        <label for="addProd">Produkt</label>
        <input type="text" id="addProd" placeholder="z. B. Hersteller …">
      </div>
      
    </div>

    <div class="entry-actions">
      <button type="button" id="addRow" class="btn btn-primary">Eintrag hinzufügen</button>
      <button type="button" id="saveExcel" class="btn btn-save">Excel speichern</button>
      <div id="entryError" class="form-error" role="alert" aria-live="polite"></div> 
     </div>
   </div>
  </div>  

  <!-- Tabelle -->
  <div id="output" class="table-wrap"></div>
</section>

  </div>
</main>

  </div>
  
  <script src="gebaeude-list.js"></script>
  <script src="xlsx.full.min.js"></script>
<script>
  const fileInput  = document.getElementById('fileInput');
  const fileNameEl = document.getElementById('fileName');
  const outputEl   = document.getElementById('output');

  // Filter aus der Sidebar (falls vorhanden)
  const inpGebFilter  = document.getElementById('filterGebaeude');
  const inpRaumFilter = document.getElementById('filterRaum');
  const btnClear      = document.getElementById('clearFilters');

  // Neue Eingabefelder (oberhalb der Tabelle)
  const addGebSel = document.getElementById('addGebSel');
  const addRaum = document.getElementById('addRaum');
  const addFarb = document.getElementById('addFarb');
  const addProd = document.getElementById('addProd');
  const btnAdd  = document.getElementById('addRow');
  const btnSave = document.getElementById('saveExcel');

  // Arbeitszustand
  let wb = null, ws = null, sheetName = null;
  let aoa = [];                         // Array-of-Arrays
  let tableEl = null;
  let originalFileName = 'Tabelle.xlsx';

  // Spaltenindex
  let colIdx = { geb: null, raum: null, farb: null, prod: null };

  // ---------- Utils
  function normalizeHeader(text) {
    return String(text || '')
      .toLowerCase()
      .replace(/\s+/g, '')
      .replace(/[.\-]/g, '')
      .replace(/ä/g,'ae').replace(/ö/g,'oe').replace(/ü/g,'ue');
  }

  function fillGebaeudeSelect(list) {
    const arr = (Array.isArray(list) ? list : []).map(s => String(s||'').trim()).filter(Boolean)
                  .sort((a,b) => a.localeCompare(b, 'de'));
    addGebSel.innerHTML = '<option value="">– bitte wählen –</option>';
    for (const name of arr) {
      const opt = document.createElement('option');
      opt.value = name; opt.textContent = name;
      addGebSel.appendChild(opt);
    }
  }
  // Beim Laden der Seite füllen (offline: aus window.GEBAEUDE_LIST)
  document.addEventListener('DOMContentLoaded', () => {
    fillGebaeudeSelect(window.GEBAEUDE_LIST || []);
  });

  function ensureHeaders() {
    if (!Array.isArray(aoa) || aoa.length === 0) {
      aoa = [['Gebäude','Raumnr.','Farbton','Produkt']];
      return;
    }
    if (!Array.isArray(aoa[0])) aoa[0] = Array.from(aoa[0]);

    const headersNorm = aoa[0].map(h => normalizeHeader(h));
    const pushIfMissing = (label, ...needles) => {
      const exists = headersNorm.some(h => needles.some(n => h.includes(n)));
      if (!exists) aoa[0].push(label);
    };
    pushIfMissing('Gebäude', 'gebaeude');
    pushIfMissing('Raumnr.', 'raumnr','raumnummer','raum');
    pushIfMissing('Farbton', 'farbton','farb','farbcode','farbnummer','farbtonnr');
    pushIfMissing('Produkt', 'produkt','artikel','produktname','artikelnummer');
  }

  function findHeaderIndexesFromAoa() {
    const H = aoa[0].map(h => normalizeHeader(h));
    const findIdx = (cands) => {
      for (let i=0;i<H.length;i++) {
        for (const c of cands) if (H[i].includes(c)) return i;
      }
      return null;
    };
    colIdx.geb  = findIdx(['gebaeude']);
    colIdx.raum = findIdx(['raumnr','raumnummer','raum']);
    colIdx.farb = findIdx(['farbton','farb','farbcode','farbnummer','farbtonnr']);
    colIdx.prod = findIdx(['produkt','artikel','produktname','artikelnummer']);
  }

  // ---------- Rendern
  function renderAndSetup() {
    ws = XLSX.utils.aoa_to_sheet(aoa);
    wb.Sheets[sheetName] = ws;
    const html = XLSX.utils.sheet_to_html(ws, { header: "", footer: "" });
    outputEl.innerHTML = html;
    tableEl = outputEl.querySelector('table');
    setupFiltering();
  }

  // ---------- Filtern (nur Gebäude/Raum – wie zuvor)
  function findHeaderIndexesForFilter() {
    if (!tableEl) { colIdx.geb = colIdx.geb ?? null; colIdx.raum = colIdx.raum ?? null; return; }
    const headerRow = tableEl.tHead?.rows?.[0] || tableEl.rows?.[0];
    if (!headerRow) return;
    const headers = Array.from(headerRow.cells).map(th => normalizeHeader(th.textContent));

    const idxOfAny = (cands) => {
      for (let i=0;i<headers.length;i++) {
        for (const c of cands) if (headers[i].includes(c)) return i;
      }
      return null;
    };
    colIdx.geb  ??= idxOfAny(['gebaeude']);
    colIdx.raum ??= idxOfAny(['raumnr','raumnummer','raum']);
  }

  function getDataRows() {
    if (!tableEl) return [];
    if (tableEl.tBodies && tableEl.tBodies.length && tableEl.tBodies[0].rows.length) {
      return Array.from(tableEl.tBodies[0].rows);
    }
    return Array.from(tableEl.rows).slice(1);
  }

  function applyFilters() {
    if (!tableEl) return;
    const fGeb  = (inpGebFilter?.value  || '').toLowerCase().trim();
    const fRaum = (inpRaumFilter?.value || '').toLowerCase().trim();

    const rows = getDataRows();
    for (const row of rows) {
      if (!row || row.cells.length === 0) continue;
      const okGeb  = !fGeb  || colIdx.geb  == null || (row.cells[colIdx.geb]  && row.cells[colIdx.geb].textContent.toLowerCase().includes(fGeb));
      const okRaum = !fRaum || colIdx.raum == null || (row.cells[colIdx.raum] && row.cells[colIdx.raum].textContent.toLowerCase().includes(fRaum));
      row.style.display = (okGeb && okRaum) ? '' : 'none';
    }
  }

  function setupFiltering() { findHeaderIndexesForFilter(); applyFilters(); }

  // ---------- Datei laden
  fileInput.addEventListener('change', (event) => {
    const file = event.target.files[0];
    if (!file) { if (fileNameEl) fileNameEl.textContent = ''; return; }
    originalFileName = file.name;
    if (fileNameEl) fileNameEl.textContent = originalFileName;

    const reader = new FileReader();
    reader.onload = function(e) {
      const data = new Uint8Array(e.target.result);
      wb = XLSX.read(data, { type: 'array' });
      sheetName = wb.SheetNames[0] || 'Tabelle1';
      ws = wb.Sheets[sheetName];

      aoa = XLSX.utils.sheet_to_json(ws, { header: 1 }) || [];
      ensureHeaders();
      findHeaderIndexesFromAoa();
      renderAndSetup();
    };
    reader.readAsArrayBuffer(file);
  });

  // ---------- Zeile hinzufügen aus 4 Feldern
  const entryError = document.getElementById('entryError');
  
  btnAdd?.addEventListener('click', () => {
  if (!wb || !aoa.length) { alert('Bitte zuerst eine Excel-Datei laden.'); return; }

  const g = (addGebSel.value || '').trim();
  const r = (addRaum.value   || '').trim();
  const f = (addFarb.value   || '').trim();
  const p = (addProd.value   || '').trim();

  // Validierung: alle müssen vorhanden sein
  const missing = [];
  if (!g) missing.push(addGebSel);
  if (!r) missing.push(addRaum);
  if (!f) missing.push(addFarb);
  if (!p) missing.push(addProd);

  // Markieren + Meldung
  [addGebSel, addRaum, addFarb, addProd].forEach(el => {
    const empty = !(el.value || '').trim();
    el.classList.toggle('invalid', empty);
  });

  if (missing.length) {
    entryError.textContent = 'Bitte alle Felder ausfüllen.';
    missing[0].focus();
    return;
  } else {
    entryError.textContent = '';
  }

  ensureHeaders();
  findHeaderIndexesFromAoa();

  const cols = aoa[0].length;
  const row = new Array(cols).fill('');
  if (colIdx.geb  != null) row[colIdx.geb]  = g;
  if (colIdx.raum != null) row[colIdx.raum] = r;
  if (colIdx.farb != null) row[colIdx.farb] = f;
  if (colIdx.prod != null) row[colIdx.prod] = p;

  aoa.push(row);

  // Felder leeren
  addGebSel.value = '';
  addRaum.value = '';
  addFarb.value = '';
  addProd.value = '';

  renderAndSetup();
});

// Invalid-Markierung live entfernen
addGebSel?.addEventListener('change', () => {
  if ((addGebSel.value || '').trim()) addGebSel.classList.remove('invalid');
  if ([addGebSel, addRaum, addFarb, addProd].every(el => (el.value || '').trim()))
    entryError.textContent = '';
});
[addRaum, addFarb, addProd].forEach(el => {
  el?.addEventListener('input', () => {
    if ((el.value || '').trim()) el.classList.remove('invalid');
    if ([addGebSel, addRaum, addFarb, addProd].every(x => (x.value || '').trim()))
      entryError.textContent = '';
  });
});

  // ---------- Excel speichern
  btnSave?.addEventListener('click', () => {
    if (!wb) { alert('Keine Daten zum Speichern. Bitte zuerst eine Excel-Datei laden.'); return; }
    const fn = originalFileName.replace(/(\.xlsx?|\.xlsm)$/i, '-bearbeitet$1');
    XLSX.writeFile(wb, fn === originalFileName ? (originalFileName + '-bearbeitet.xlsx') : fn);
  });

  // Live-Filter (Sidebar)
  inpGebFilter?.addEventListener('input', applyFilters);
  inpRaumFilter?.addEventListener('input', applyFilters);
  btnClear?.addEventListener('click', () => { if (inpGebFilter) inpGebFilter.value=''; if (inpRaumFilter) inpRaumFilter.value=''; applyFilters(); });
</script>

</body>
</html>





